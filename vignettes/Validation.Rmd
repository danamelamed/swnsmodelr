---
title: "Validation"
author: "Dana Melamed"
date: "`r Sys.Date()`"
output: word_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align = 'center')
knitr::opts_chunk$set(fig.width = 9)
knitr::opts_chunk$set(fig.height = 7)
library(swnsmodelr)
par(mfrow=c(2,2))
```



```{r}
ecodist_avg_df <- model_stations_df.1 %>% 
  dplyr::select(stationid,date_time,gdd10_daily,ecodist) %>%
  group_by(date_time,ecodist) %>%
  mutate(gdd10_ecodist_daily = round(mean(gdd10_daily,na.rm=TRUE)))%>%
  ungroup() %>%
  dplyr::select(ecodist,date_time,gdd10_ecodist_daily) %>%
  distinct()

validation_stations_df.2 <- validation_stations_df.1 %>%
  left_join(ecodist_avg_df,by=c('date_time','ecodist')) %>%
  mutate(gdd10_daily_2 = ifelse(is.na(gdd10_daily),
                              gdd10_ecodist_daily,
                              gdd10_daily)) %>%
  group_by(stationid,year(date_time)) %>%
  mutate(gdd10_daily_2 = ifelse(is.na(gdd10_daily_2),
                               0,
                               gdd10_daily_2))%>%
  mutate(gdd10_acc_2 = cumsum(gdd10_daily_2))%>%
  ungroup()

```


```{r}
east_north_lookup_df.2 <- read.csv('f:\\data\\validation_stations_unique.csv')
validation_stations_df.3 <- validation_stations_df.2 %>% 
  dplyr::select(-c(EASTING,NORTHING))%>%
  left_join(east_north_lookup_df.2,by='stationid')

```



```{r}
variables <- c('gdd10','gdd5','gdd5_5ya','gdd0')
validation_stations_df.4 <- validation_stations_df.3
for(var in variables){
  rasters_df <- swnsmodelr::make_temporal_raster_df(
    in_folder = paste0('f:\\output\\for_validation\\',var),
    start_date = ymd('2012-04-30'),
    end_date = ymd('2016-11-30'),
    date_chars = c(7,16),
    date_format = '%Y_%m_%d')

  validation_stations_df.4 <- swnsmodelr::extract_temporal_raster_values(
    temporal_rasters_df = rasters_df, 
    temperatures_df = validation_stations_df.4, 
    paste0(var,'_predicted'),
    verbose = FALSE) 
}



```

```{r}
validation_stations_df.5 <- validation_stations_df.4 %>% 
  mutate(gdd10_resid = gdd10_acc_2 - gdd10_predicted) %>%
  group_by(stationid,year(date_time))%>%
  filter(date_time == max(date_time)) %>%
  ungroup() %>%
  dplyr::select(-c(EASTING,NORTHING)) %>%
  left_join(east_north_lookup_df.1,by='stationid') %>%
  filter(gdd10_resid < 500&gdd10_resid>-500)
write.csv(validation_stations_df.5,'f:\\data\\validation_stations_resid.csv')
```







---
title: "Validation"
author: "Dana Melamed"
date: "`r Sys.Date()`"
output: word_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align = 'center')
knitr::opts_chunk$set(fig.width = 9)
knitr::opts_chunk$set(fig.height = 7)
library(swnsmodelr)
par(mfrow=c(2,2))
```


Calculate residuals and (later) number of missing days per validation station
```{r}
validation_stations <- validation_stations %>% 
  group_by(stationid,year(date_time),month(date_time)) %>%
  filter(date_time == max(date_time))


months_df <- list()
c <-1
for(month in seq(4,11,1)){
  model_stations_now <- model_stations %>% filter(year(date_time)==2012 & month(date_time) == month)
  m <- gam(gdd10_acc ~ s(dem) + s(cp) + s(east,north), data = model_stations_now)
  
  validation_stations_now <- validations_stations %>% filter(year(date_time)==2012 & month(date_time) == month)
  year_df[[c]] <- add_residuals(validation_stations_now,m)
  c <- c+1
}
validation_months <- bind_rows(months_df)




year_df <- list()
c <-1
for(year in seq(2012,2016,1)){
  model_stations_now <- model_stations %>% filter(year(date_time)==year)
  m <- gam(gdd10_acc ~ s(dem) + s(cp) + s(east,north), data = model_stations_now)
  
  validation_stations_now <- validations_stations %>% filter(year(date_time)==year)
  year_df[[c]] <- add_residuals(validation_stations_now,m)
  c <- c+1
}
validation_years <- bind_rows(years_df)

```

Missing dates per station
```{r}
# check dates missing at stations


years <- seq(2012,2016,1)
missing_dates_df <- data.frame(matrix(ncol = 3, nrow = length(validation_stations_list)*length(years)))
colnames(missing_dates_df) <- c('stationid','missing_days','date_time')

c <- 1
for(year in years){
start <- ymd(paste0(year,'-04-30'))
end <- ymd(paste0(year,'-11-30'))
date_range <- seq(start, end, by = 1) 
  for(station in validation_stations_list){
print(station)
  df_test <- stations_df %>% filter(stationid==station)
  d <- df_test$date_time

missing_days <- length(date_range[!date_range %in% d] )
missing_dates_df$stationid[[c]] <- station
missing_dates_df$missing_days[[c]] <- missing_days
missing_dates_df$date_time[[c]] <- (paste0(year,'-11-30'))
c <- c+1
}
  }
missing_dates_df <-missing_dates_df %>% mutate(date_time = as.Date(date_time))
validation_stations <- left_join(validation_stations,missing_dates_df,by=c('stationid','date_time'))
```




---
title: "Vignette"
author: "Dana Melamed"
date: "April 30, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_knit$set(root.dir = 'D:\\swnsmodelr')
#install.packages('randomcoloR')
library(swnsmodelr)
```

## Selecting Rasters as Inputs

Rasters of physical properties of the environment that are constant through time are referred to as "constant rasters" in the package. Examples of these rasters, that are provided as extra data, are the elevation, aspect, slope, proximity to coast line, easting and northing values of the region. Since the values from these rasters do not change over time, they only need to be extracted to the weather station points once. In this section is an overview of how to select and manipulate these rasters.

### Transform Aspect Values

Create the aspect rasters as per Guan et al, 2013

```{r, eval = FALSE}
# as per Guan et al 2013
rasters_dir <- file.path('D:','data','rasters','input_rasters')
resolutions = list(20,100,200,700,1000)
for(resolution in resolutions){
for(raster in rasters_list){
if(yres(raster)== resolution){
  if(substring(names(raster),1,3)== 'asp'){
  
    asp <- raster
   
  }
  if(substring(names(raster),1,3)== 'slp'){
    slp <- raster
  }
}
}
aspg <- slp*cos(asp)
writeRaster(aspg, file.path(rasters_dir,paste0('aspg',resolution,'m.tif')),
            overwrite = TRUE)
}

```





### Bring Constant Rasters into R Environment

Throughout the modelling workflow provided in the swnsmodelr package, the constant rasters should be in the form of raster objects in a list. Rasters have been provided in the swnsmodelr project. Selecting rasters from the project folder and storing them as a list of raster objects can be done with the following code:
```{r, results = "hide", error = FALSE}
# See list of rasters in Rasters project folder


# Store names of rasters from list
rasters_dir <- file.path('D:','data','rasters','input_rasters')
rasters_names_list <- c("dem","tpi300m",'tpi2000m',"aspg","east","north","cp","slp")
resolutions <- c('20m','100m','200m','700m','1000m')

all_rasters <-  file.path(rasters_dir,paste0(as.list(outer(rasters_names_list,resolutions,paste0)),'.tif'))

rasters_list <- list()
c <- 1
for(raster in all_rasters){
  try({rasters_list[[c]] <- raster(raster)
       c <- c+1
       }) 
}

```

Extract values of constant rasters at stations to a dataframe.


```{r}
stations_df <- extract_constant_raster_values(swns_stations_df,
                                              rasters_list)
stations_melt_df <- reshape2::melt(stations_df, id.vars = c('stationid','date_time','temp_min','temp_max','temp_mean','EASTING','NORTHING'))


```  


### Bring Temporal Rasters into R Environment
This stage requires two steps. In the first step, using `swnsmodelr::make_temporal_rasters_df()` the paths for all the temporal rasters are stored in a dataframe, with their corresponding date. This data frame is called the temporal rasters dataframe. In the second step, the temporal rasters dataframe is used to point to rasters, and extract their values to the `stations_df`. Here, the temporal rasters dataframe is called `solar_irradiance_rasters_df`.

```{r, message = FALSE}
resolutions = c('20m','100m','200m','700m','1000m')
for(res in resolutions){
  
solar_irradiance_rasters_df <- make_temporal_raster_df(
  in_folder = paste0("D:\\GOES\\",res),
  start_date = ymd('2012-01-01'),
  end_date   = ymd('2017-12-31'),
  date_chars = c(16,-5),
  date_format = "%Y_%j",
  extension = ".tif")
stations_df <- extract_temporal_raster_values(solar_irradiance_rasters_df,
                                              stations_df,
                                              paste0('solar',res))
}
```

melt
```{r}
stations_vars_df <-  stations_melt_df %>% 
  mutate(var = ifelse(grepl('dem',variable),'dem','')) %>%
  mutate(var = ifelse(grepl('tpi300m',variable),'tpi300m',var)) %>%
  mutate(var = ifelse(grepl('tpi2000m',variable),'tpi2000m',var)) %>%
  mutate(var = ifelse(grepl('aspg',variable),'aspg',var)) %>%
  mutate(var = ifelse(grepl('east',variable),'east',var)) %>%
  mutate(var = ifelse(grepl('north',variable),'north',var)) %>%
  mutate(var = ifelse(grepl('slp',variable),'slp',var)) %>%
  mutate(var = ifelse(grepl('cp',variable),'cp',var)) %>%
  mutate(res = ifelse(grepl('20',variable),'20','')) %>%
   mutate(res = ifelse(grepl('100',variable),'100',res)) %>%
   mutate(res = ifelse(grepl('200',variable),'200',res)) %>%
   mutate(res = ifelse(grepl('700',variable),'700',res)) %>%
  mutate(res = ifelse(grepl('1000',variable),'1000',res)) 

```



#### Exploratory Data Analysis

##### Raster values 

Check out raster statistics as a table
```{r}
rasters_names_list <- c("dem","slp","aspg","cp","tpi300m","tpi2000m","north","east")
df <- data.frame(names = character(),min=double(),mean=double(),max=double())
c <- 0
for(raster_name in rasters_names_list){
  names_list <- list()

  for(raster in rasters_list){
   
    if(substring(names(raster),1,3) == substring(raster_name,1,3)){
      
      if(substring(names(raster),1,3) == 'tpi'){
        if(substring(names(raster),1,4) == substring(raster_name,1,4)){
          
          name <- names(raster)
          max<-cellStats(raster,'max')
          min<-cellStats(raster,'min')
          mean<-cellStats(raster,'mean')
          df[nrow(df) + 1,] <- c(name,min,mean,max)
           c <- c +1
        }
      }else{
        name <- names(raster)
          max<-cellStats(raster,'max')
          min<-cellStats(raster,'min')
          mean<-cellStats(raster,'mean')
          df[nrow(df) + 1,] <- c(name,min,mean,max)
           c <- c +1
          
      }
      
    }
    
    if(substring(names(raster),1,2) == 'cp'){
      if(substring(names(raster),1,2) == substring(raster_name,1,2)){
       name <- names(raster)
          max<-cellStats(raster,'max')
          min<-cellStats(raster,'min')
          mean<-cellStats(raster,'mean')
          df[nrow(df) + 1,] <- c(name,min,mean,max)
           c <- c +1 
      }
    }
    
   
  }
  
  
}

#write.csv(df, 'd:\\data\\raster_stats.csv')
```




Check out histograms of the raster values. Compare between different resolutions.
```{r, echo = FALSE}

# get all rasters as list of lists
variables <- list('dem','slp','aspg','cp','tpi300m','tpi2000m','north','east')

raster_lists <- list()
for(j in 1:length(variables)){
  
  if(variables[j]=='tpi300m'){
    resolutions <- list('20','100','200')
  }else{
    resolutions <- list('20','100','200','700','1000')
  }
  inner_list <- list()
  for(i in 1:length(resolutions)){
   
    inner_list[[i]] <-raster(paste0('d:\\data\\rasters\\input_rasters\\',variables[j],resolutions[i],'m.tif'))
  }
  raster_lists[[j]] <- inner_list
}



# create histograms for every raster... keep the bins the same as the 20m resolution raster
q <- list()
for(j in 1:length(raster_lists)){
  p <- list()
  
  
  for(i in 1:length(raster_lists[[j]])){
    if(i == 1){
      # get breaks
      h <- hist(getValues(raster_lists[[j]][[i]]), plot = FALSE, main = variables[[j]], nclass = 28)
      }
    
  
   tryCatch(
    expr = {m <- graphics::hist(getValues(raster_lists[[j]][[i]]), breaks = h$breaks
            , main = paste0(variables[[j]],resolutions[[i]]),xlab = 'Raster Cell Value')},
    error = function(e){ 
     # print(raster_lists[[j]][[i]]%>%names)
         m <- graphics::hist(getValues(raster_lists[[j]][[i]])
                  , main = paste0(variables[[j]],resolutions[[i]])
                  , xlab = 'Raster Cell Value'
                  , nclass = 28)}
            )
    
  print(raster_lists[[j]][[i]]%>%names) 
  p[[i]] <- m
  }
  
 q[[j]] <- p   
}


```

Take a look at numbers from histograms

```{r}
# for each variable
df_list <- list()
c = 1
for(p in q){
  df <- data.frame(mids20m = p[[1]]$mids)

  try(df$var20m <- p[[1]]$counts/sum(p[[1]]$counts)*100)
  try(df$var100m <- p[[2]]$counts/sum(p[[2]]$counts)*100)
  try(df$var200m <- p[[3]]$counts/sum(p[[3]]$counts)*100)
  try(df$var700m <- p[[4]]$counts/sum(p[[4]]$counts)*100)
  try(df$var1000m <- p[[5]]$counts/sum(p[[5]]$counts)*100)
  df_list[[c]] <- df
  c <- c+ 1
  
}

for(df in df_list){
  print(kable(df, digits = 2))
}


```

Create histograms
```{r}
#for each df in the list
i <- 1
for(df in df_list){
      var = variables[i]
      print(ggplot(data = df, aes(x = mids20m, y = var20m))+
       geom_bar(stat='identity')+
        labs(y = 'Percentage', x = paste0(var,'20m')))
      print(ggplot(data = df, aes(x = mids20m, y = var100m))+
        geom_bar(stat='identity')+
        labs(y = 'Percentage', x = paste0(var,'100m')))
      print(ggplot(data = df, aes(x = mids20m, y = var200m))+
        geom_bar(stat='identity')+
        labs(y = 'Percentage', x = paste0(var,'200m')))
      try(print(ggplot(data = df, aes(x = mids20m, y = var700m))+
        geom_bar(stat='identity')+
        labs(y = 'Percentage', x = paste0(var,'700m'))))
      try(print(ggplot(data = df, aes(x = mids20m, y = var1000m))+
        geom_bar(stat='identity')+
        labs(y = 'Percentage', x = paste0(var,'1000m'))))
     i <- i+1
  
  }

```

##### Raster values  at weather stations
Ideally, weather stations would cover the full range of raster values. Also, compare between resolutions.
```{r}
for(raster in rasters_list){
  df <- extract(raster, swns_stations_sp) %>% sort
  plot(x=seq(1:length(df)),df,
             ylim = c(cellStats(raster,min),cellStats(raster,max)),
       xlab = "Stations",
       ylab= names(raster))
}
```




##### Temperature values over the year
Check out the temperatures recorded at each station over the year, for each year.
```{r}

for(station_now in stations_df$stationid %>% unique()){
print(ggplot(data = stations_df %>% filter(stationid == station_now), aes(x = yday, y = temp_mean)) +
        geom_smooth(aes(colour = year_factor)) +
        labs(title=station_now)
      )

}

```
---
title: "Data Exploration"
author: "Dana Melamed"
date: "April 30, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_knit$set(root.dir = 'F:\\swnsmodelr')
#install.packages('randomcoloR')
library(swnsmodelr)
library(ggplot2)
library(knitr)
```

## The Temperature Data
The temperature data is a dataframe of daily temperature readings at stations in South-West Nova Scotia. The fields are the date (`date_time`), the station location (`EASTING` and `NORTHING`), and temperature minimum and maximum (`temp_min` and `temp_max`, respectively).

```{r}
temperatures_df <- read.csv('f:\\WeatherData\\daily_20110101_20180218.csv')
temperatures_df <- temperatures_df %>% dplyr::select(date_time,
                                                 stationid,
                                                 temp_min,
                                                 temp_max)

stations_info_df <- read.csv('f:\\WeatherData\\NSWeatherStns.csv')
stations_info_df <- stations_info_df %>% dplyr::select(stationid = StnID,
                                                       NORTHING = Northing, 
                                                       EASTING = Easting,
                                                       type = StnType)
stations_df <- dplyr::left_join(temperatures_df,
                                stations_info_df,
                                by = 'stationid') %>%
  filter(!is.na(EASTING))

# Calculate daily mean temperature, GDD10, and total GDD10 (Apr-Nov)
stations_df <- stations_df %>%
  mutate(temp_mean = (temp_min + temp_max)/2) %>%
  mutate(gdd10_daily = (ifelse(temp_mean>10,temp_mean-10,0))) %>%
  filter(between(month(date_time),4,11)) %>% 
  filter(stationid!='S40')%>%
  group_by(stationid,year(date_time)) %>%
  mutate(gdd10 = sum(round(gdd10_daily),0)) %>%
  #mutate(gdd10 = sum(gdd10_daily)) %>%
  ungroup()
  

usethis::use_data(stations_df,overwrite=TRUE)
```

Find missing data 
```{r}
gs_df <- stations_df %>% filter(year(date_time)=='2013') %>%
 filter(stationid %in% nscc_stations_list | stationid == '47187' | stationid =='6354')
stations <- gs_df$stationid %>% unique()

for(station in stations){
    dataframe <- gs_df %>% filter(stationid == !!station)
    d <- dataframe$date_time 
    d <- as.Date(d)
    date_range <- seq(min(d), max(d), by = 1) 


    
    if(length(date_range[!date_range %in% d])>0){
      print(station)
    print(date_range[!date_range %in% d] )
    }
    

}
```
## Selecting Rasters as Inputs

Rasters of physical properties of the environment that are constant through time are referred to as "constant rasters" in the package. Examples of these rasters, that are provided as extra data, are the elevation, aspect, slope, proximity to coast line, easting and northing values of the region. Since the values from these rasters do not change over time, they only need to be extracted to the weather station points once. In this section is an overview of how to select and manipulate these rasters.

### Bring Constant Rasters into R Environment

Throughout the modelling workflow provided in the swnsmodelr package, the constant rasters should be in the form of raster objects in a list. Rasters have been provided in the swnsmodelr project. Selecting rasters from the project folder and storing them as a list of raster objects can be done with the following code:
```{r create rasters_list, results = "hide", error = FALSE}
# See list of rasters in Rasters project folder


# Store names of rasters from list
rasters_dir <- file.path('F:','data','rasters','input_rasters')
rasters_names_list <- c("dem",'tpi2000m','tpi5000m',
                        "asp","east","north","cp","slp")
res <- '700m' #multiple can be specified with c()
rasters_list <- create_rasters_list(rasters_dir,
                                    rasters_names_list,
                                    res)


```


Extract values of constant rasters at stations to a dataframe.
```{r extract constant rasters}
stations_df <- extract_constant_raster_values(stations_df,
                                              rasters_list)


```  


Created a melted dataframe for exploratory analysis
```{r melt dataframe}
stations_melt_df <- reshape2::melt(stations_df, id.vars = c('stationid','date_time','temp_min','temp_max','temp_mean','EASTING','NORTHING'))
stations_melt_df <-  stations_melt_df %>% 
  mutate(var = ifelse(grepl('dem',variable),'dem','')) %>%
  mutate(var = ifelse(grepl('tpi300m',variable),'tpi300m',var)) %>%
  mutate(var = ifelse(grepl('tpi2000m',variable),'tpi2000m',var)) %>%
  mutate(var = ifelse(grepl('tpi5000m',variable),'tpi5000m',var)) %>%
  mutate(var = ifelse(grepl('asp',variable),'asp',var)) %>%
  mutate(var = ifelse(grepl('east',variable),'east',var)) %>%
  mutate(var = ifelse(grepl('north',variable),'north',var)) %>%
  mutate(var = ifelse(grepl('slp',variable),'slp',var)) %>%
  mutate(var = ifelse(grepl('cp',variable),'cp',var)) %>%
  mutate(var = ifelse(grepl('solar',variable),'solar',var)) %>%
  mutate(res = ifelse(grepl('20',variable),'20','')) %>%
   mutate(res = ifelse(grepl('100',variable),'100',res)) %>%
   mutate(res = ifelse(grepl('200',variable),'200',res)) %>%
   mutate(res = ifelse(grepl('700',variable),'700',res)) %>%
  mutate(res = ifelse(grepl('1000',variable),'1000',res)) 

```



### Exploratory Data Analysis

#### Raster values 

Check out raster statistics as a table
```{r raster statistics}
rasters_names_list <- c("dem","slp","asp","cp","tpi300m","tpi2000m","tpi5000m","north","east")
df <- data.frame(names = character(),min=double(),mean=double(),max=double())
c <- 0
for(raster_name in rasters_names_list){
  names_list <- list()

  for(raster in rasters_list){
   
    if(substring(names(raster),1,3) == substring(raster_name,1,3)){
      
      if(substring(names(raster),1,3) == 'tpi'){
        if(substring(names(raster),1,4) == substring(raster_name,1,4)){
          
          name <- names(raster)
          max<-cellStats(raster,'max')
          min<-cellStats(raster,'min')
          mean<-cellStats(raster,'mean')
          df[nrow(df) + 1,] <- c(name,min,mean,max)
           c <- c +1
        }
      }else{
        name <- names(raster)
          max<-cellStats(raster,'max')
          min<-cellStats(raster,'min')
          mean<-cellStats(raster,'mean')
          df[nrow(df) + 1,] <- c(name,min,mean,max)
           c <- c +1
          
      }
      
    }
    
    if(substring(names(raster),1,2) == 'cp'){
      if(substring(names(raster),1,2) == substring(raster_name,1,2)){
       name <- names(raster)
          max<-cellStats(raster,'max')
          min<-cellStats(raster,'min')
          mean<-cellStats(raster,'mean')
          df[nrow(df) + 1,] <- c(name,min,mean,max)
           c <- c +1 
      }
    }
    
   
  }
  
  
}
print(kable(df))
#write.csv(df, 'd:\\data\\raster_stats.csv')
```




Check out histograms of the raster values. Compare between different resolutions.
```{r, echo = FALSE, eval =FALSE}

# # get all rasters as list of lists
variables <- list('dem','slp','aspg','cp','tpi300m','tpi2000m','tpi5000m','north','east')

raster_lists <- list()
for(j in 1:length(variables)){

  if(variables[j]=='tpi300m'){
    resolutions <- list('20','100','200')
  }else{
    resolutions <- list('20','100','200','700','1000')
  }
  inner_list <- list()
  for(i in 1:length(resolutions)){

    inner_list[[i]] <-raster(paste0('f:\\data\\rasters\\input_rasters\\',variables[j],resolutions[i],'m.tif'))
  }
  raster_lists[[j]] <- inner_list
}



# create histograms for every raster... keep the bins the same as the 20m resolution raster
q <- list()
for(j in 1:length(raster_lists)){
  p <- list()
  
  
  for(i in 1:length(raster_lists[[j]])){
    if(i == 1){
      # get breaks
      h <- graphics::hist(getValues(raster_lists[[j]][[i]]), plot = FALSE, main = variables[[j]], nclass = 28)
      }
    
  
   tryCatch(
    expr = {m <- graphics::hist(getValues(raster_lists[[j]][[i]]), breaks = h$breaks
            , main = paste0(variables[[j]],resolutions[[i]]),xlab = 'Raster Cell Value',
            freq = FALSE)},
    error = function(e){ 
     # print(raster_lists[[j]][[i]]%>%names)
         m <- graphics::hist(getValues(raster_lists[[j]][[i]])
                  , main = paste0(variables[[j]],resolutions[[i]])
                  , xlab = 'Raster Cell Value'
                  , nclass = 28
                  , freq = FALSE)}
            )
    
  print(raster_lists[[j]][[i]]%>%names) 
  p[[i]] <- m
  }
  
 q[[j]] <- p   
}


```

Take a look at numbers from histograms

```{r}
# for each variable
df_list <- list()
c = 1
for(p in q){
  df <- data.frame(mids20m = p[[1]]$mids)

  try(df$var20m <- p[[1]]$counts/sum(p[[1]]$counts)*100)
  try(df$var100m <- p[[2]]$counts/sum(p[[2]]$counts)*100)
  try(df$var200m <- p[[3]]$counts/sum(p[[3]]$counts)*100)
  try(df$var700m <- p[[4]]$counts/sum(p[[4]]$counts)*100)
  try(df$var1000m <- p[[5]]$counts/sum(p[[5]]$counts)*100)
  df_list[[c]] <- df
  c <- c+ 1
  
}

for(df in df_list){
  print(kable(df, digits = 4))
}


```

Create histograms
```{r}
#for each df in the list
i <- 1
for(df in df_list){
      var = variables[i]
      print(ggplot(data = df, aes(x = mids20m, y = var20m))+
       geom_bar(stat='identity')+
        labs(y = 'Percentage', x = paste0(var,'20m')))
      print(ggplot(data = df, aes(x = mids20m, y = var100m))+
        geom_bar(stat='identity')+
        labs(y = 'Percentage', x = paste0(var,'100m')))
      print(ggplot(data = df, aes(x = mids20m, y = var200m))+
        geom_bar(stat='identity')+
        labs(y = 'Percentage', x = paste0(var,'200m')))
      try(print(ggplot(data = df, aes(x = mids20m, y = var700m))+
        geom_bar(stat='identity')+
        labs(y = 'Percentage', x = paste0(var,'700m'))))
      try(print(ggplot(data = df, aes(x = mids20m, y = var1000m))+
        geom_bar(stat='identity')+
        labs(y = 'Percentage', x = paste0(var,'1000m'))))
     i <- i+1
  
  }

```

##### Raster values  at weather stations
Ideally, weather stations would cover the full range of raster values. Also, compare between resolutions.
```{r , echo = FALSE}
library(swnsmodelr)
library(ggplot2)
in_df <- swns_new %>% dplyr::filter(date_time == ymd('2012-06-01')) %>% 
    mutate(station = ifelse(stationid %in% nscc_stations_list,'nscc','ext'))
for(raster in rasters_list){
  col <- raster %>% names()
  df <- extract_constant_raster_values(in_df,list(raster)) %>% 
    arrange(.data[[col]])

  print(ggplot(data = df, aes(x = reorder(stationid, 1:length(df[[1]])), y = .data[[col]])) +
          geom_point(aes(fill = station, shape = station),size = 2.2, alpha = 0.8) +
          labs(x = 'Stations',y = .data[[col]], title = col) +
          scale_y_continuous(limits = c(cellStats(raster,min),cellStats(raster,max))) +
          scale_shape_manual(values=c(21,24))+
          
          theme(
            axis.text.x=element_blank(),
            panel.background = element_rect(fill='white', colour = 'grey'), #transparent panel bg
            #plot.background = element_rect(fill='white',colour ='white'), #transparent plot bg
            panel.grid.major.y =   element_line(color = 'grey'), #remove major gridlines
            panel.grid.major.x = element_blank(), #remove minor gridlines
            #legend.background = element_rect(fill='transparent'), #transparent legend bg
            legend.box.background = element_rect(fill='transparent',colour='grey'), #transparent legend panel
            legend.key = element_rect(colour = 'grey', fill = NA)
          ) 
          

  
  )
  
  
}

```


##### Maximum and minimum raster values at weather stations
What are the maximum and minimum values covered by weather stations for each raster?
```{r}
options(scipen=999)
# get weather station values for a single day
df <- stations_vars_df %>% 
  # dplyr::filter(stationid %in% nscc_stations_list) %>%
  dplyr::filter(date_time == ymd('2012-08-01'))
df_max <- df  %>%
  group_by(variable) %>%
  slice_max(value) %>%
  ungroup() 

df_min <- df   %>%
  group_by(variable) %>%
  slice_min(value) %>%
  ungroup() 


df_out <- bind_rows(df_max,df_min)

```

##### Temperature values over the year
Check out the temperatures recorded at each station over the year, for each year.
```{r}

for(station_now in stations_df$stationid %>% unique()){
print(ggplot(data = stations_df %>% dplyr::filter(stationid == station_now), aes(x = yday, y = temp_mean)) +
        geom_smooth(aes(colour = year_factor)) +
        labs(title=station_now)
      )

}




df <- start_df %>% filter(year=='2012' &month==6)
ggplot(data=df,aes(x=date_time,y=temp_mean)) +geom_point()


```


### Model the temperatures

#### Define the model
```{r}
df <- swns_stations_df %>% add_date_columns() %>%
  mutate(year = as.factor(year)) %>%
 # dplyr::filter(year == 2012) %>%
  dplyr::filter(stationid %in% swnsmodelr::nscc_stations_list |
           stationid == '6354' | #greenwood
           stationid=='47187' |  #halifax (little arm)
           stationid =='6456'    #halifax
          )  %>%
  extract_constant_raster_values(list(cp700m_10km,tpi7000m700m,cp700m_2)) 

# 
# ggplot(data=df,aes(x=east200m,y=north200m))+
#   geom_point(aes(col=temp_mean)) +
#   scale_color_gradientn(colors=rev(rainbow(10))) +
#   labs(title = df$date_time[[1]])


  # m2 <- gam(temp_mean ~
  #    #     year+
  #      #   s(east200m, k = 5) +
  #         s(dem200m,by=yday, k=5) +
  #      s(tpi7000m200m,by=yday, k=5) 
  #     # s(solar200m,by=yday,k=5)
  #    #      s(cp200m, k = 3) + 
  #     #       s(dem200m,north200m, k = 5) +
  #     #      s(cp200mdem200m)
  #          , data=df )
  # 
   
  

  

```
Check out residuals at validation (external) stations
```{r}
resid_df <- swns_stations_df_2012 %>% 
  dplyr::filter(stationid %in% swnsmodelr::ext_stations_list) %>%
  add_date_columns()
resid_df <- add_residuals(resid_df,m1, var = "resid_m1") 
resid_df <- add_residuals(resid_df,m2, var = "resid_m2") 

ggplot(data=resid_df %>% dplyr::filter(year == 2012)) +
  geom_line(aes(x=date_time, y=resid_m1),colour='orange')   
  geom_line(aes(x=date_time, y=resid_m2),colour='blue')   
  
```




Calculate Daily GDD rasters from daily temperature mean rasters
```{r}
in_raster_folder <- "f://output//daily_mean//gs_model//"
out_raster_folder <- "f://output//gdd10//gs_model//"


# Calculate GDD5
t_base <- 10


years <- c('2012')

df <- make_temporal_raster_df(in_raster_folder,
                              ymd('2012-04-01'),
                              ymd('2017-11-30'),c(12,21),'%Y-%m-%d')


for(year in years){
  year_df <- df %>% dplyr::filter(year(date_time)==!!year)
  
  c=0
  for(raster_path in year_df[[1]]){
    
    raster_name <- basename(raster_path)
    new_name <- paste('gdd',10,substring(raster_name,
                                         11,
                                         nchar(raster_name)),
                      sep="_")
    
    mean_raster <- raster::raster(raster_path)
    gdd_raster <- mean_raster -t_base
    gdd_raster[gdd_raster < 0] <- 0
    if(c >0){
      gdd_raster <- acc_raster + gdd_raster
      
    }
    raster::writeRaster(gdd_raster,
                        file.path(out_raster_folder,new_name),
                        overwrite = TRUE)
    plot(gdd_raster)
    acc_raster <- gdd_raster
    
    
    
    c<-c+1
  }
}



```



Which solar days are missing?
```{r}
d <- solar_irradiance_rasters_df$date_time
d <- as.Date(d)
date_range <- seq(min(d), max(d), by = 1) 
date_range[!date_range %in% d] 

```

